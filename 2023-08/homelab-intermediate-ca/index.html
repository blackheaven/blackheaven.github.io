<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://blackheaven.github.io">

    
    <title>Gautier DI FOLCO • Homelab: Intermediate CA</title>

    
    
        <link rel="icon" type="image/png" href="https://blackheaven.github.io/favicon-16x16.png"/>
    
    

    
    
        
            
            
                
                    <link rel="alternate" type="application/atom+xml" title="Gautier DI FOLCO - Atom Feed" href="https://blackheaven.github.io/atom.xml">
                
            
        
    

    
    
    
        <link rel="stylesheet" href="https://blackheaven.github.io/inter_subset_en.css?h=d8cf4ad058d6c3a4015b">
    

    
        <link rel="stylesheet" href="https://blackheaven.github.io/main.css?h=4709f1203e8bd6b4162f" />
        <link rel="stylesheet" href="https://blackheaven.github.io/skins/blue.css?h=a4dc1e94d3f5759784d2" />

    <meta name="color-scheme" content="dark" />
        <meta name="description" content="A software engineer website" />
        <meta property="og:description" content="A software engineer website" />

    
        <meta name="robots" content="index, nofollow" />
    

    <meta property="og:title" content="Homelab: Intermediate CA" />
    <meta property="og:type" content="article" />

    

    <meta property="og:locale" content="en_GB" />

    <meta property="og:url" content="https:&#x2F;&#x2F;blackheaven.github.io&#x2F;2023-08&#x2F;homelab-intermediate-ca&#x2F;" /><meta property="og:site_name" content="Gautier DI FOLCO"><meta http-equiv="Content-Security-Policy"
content="default-src 'self';font-src &#x27;self&#x27; data: 'self';img-src &#x27;self&#x27; https:&#x2F;&#x2F;* data:;media-src &#x27;self&#x27;;style-src &#x27;self&#x27; 'unsafe-inline';frame-src player.vimeo.com https:&#x2F;&#x2F;www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'">
<script defer src="https://blackheaven.github.io/search_index.en.js?h=9ff10f9e8fb83581467d"></script>
        <script defer src="https://blackheaven.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script>

        </head>


<body>
    <header>
    <nav class="navbar">
        <div class="nav-title">
            <a class="home-title" href="https://blackheaven.github.io">Gautier DI FOLCO</a>
        </div>
            <div class="nav-navs">
                <ul>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/foss/">
                                FOSS Contributions
                                </a>
                            </li>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/activities/">
                                Activities
                                </a>
                            </li>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/hiring/">
                                Hire me
                                </a>
                            </li>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/talks/">
                                Talks
                                </a>
                            </li>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/blog/">
                                Posts
                                </a>
                            </li>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/categories/">
                                Categories
                                </a>
                            </li>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/tags/">
                                Tags
                                </a>
                            </li>
                        <div class="nav-navs" id="menu-icons-group">
                        <li class="js">
                            <div role="button" tabindex="0" id="search-button" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" aria-label="Click or press $SHORTCUT to open search">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                                </svg>
                            </div>
                        </li>

                        
                        

                        </div>
                </ul>
            </div>
        
    </nav>
</header>

    <div class="content">

        
        




<main>
    <article>
        <h1 class="article-title">
            Homelab: Intermediate CA
        </h1>

        <ul class="meta">
                <li>27th Aug 2023</li>
                <li title="275 words"><span class='separator' aria-hidden='true'>•</span>2 min read</li><li class="tag"><span class='separator' aria-hidden='true'>•</span>Tags:&nbsp;</li><li class="tag"><a href="https://blackheaven.github.io/tags/ops/">ops</a>,&nbsp;</li><li class="tag"><a href="https://blackheaven.github.io/tags/nix/">nix</a>,&nbsp;</li><li class="tag"><a href="https://blackheaven.github.io/tags/nixos/">nixos</a>,&nbsp;</li><li class="tag"><a href="https://blackheaven.github.io/tags/pki/">pki</a></li>
        </ul>

        <section class="body"><p>When I have introduced <a href="https://blackheaven.github.io/2023-08/homelab-server-certificates/">server certificates</a> I have used a simple Certificate Authority (CA).
Which means that the trusted CA is also the one signing the server certificate.
Consequently, key and passphrase of the trusted CA should be accessible for server certificate signing phase.</p>
<p>Doing so prevents the deployment on the server (<em>Barracuda</em>), which also prevents regular certificates generation (more on that in the next log).</p>
<p>That why we want to rely on an <em>Intermediate CA</em>, so we'll end up with:</p>
<ul>
<li>a <em>root CA</em>, which will be trusted by the clients (i.e. <em>Looping</em>)</li>
<li>an <em>Intermediate CA</em> deployed on <em>Barracuda</em> and signing <em>server certificates</em></li>
</ul>
<p>Note that I base my set-up on <a rel="noopener" target="_blank" href="https://jamielinux.com/docs/openssl-certificate-authority/">Jamie Nguyen's OpenSSL Certificate Authority guide</a>,</p>
<p>First, we have to generate le <em>root CA</em>:</p>
<pre class="z-code"><code><span class="z-text z-plain">##!/usr/bin/env bash
</span><span class="z-text z-plain">set -xeuo pipefail
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">CA_DIR=server/generated/ca-root
</span><span class="z-text z-plain">REQ_DIR=server/requests
</span><span class="z-text z-plain">COMMON_NAME=&quot;Barracuda Root Certificate Authority&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">mkdir -p $CA_DIR
</span><span class="z-text z-plain">touch $CA_DIR/ca.index
</span><span class="z-text z-plain">openssl rand -hex 16 &gt; $CA_DIR/ca.serial
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">mkdir &quot;$CA_DIR/certs&quot; &quot;$CA_DIR/newcerts&quot; &quot;$CA_DIR/private&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">echo &quot;./$REQ_DIR/mk-ca.conf.dhall \&quot;$CA_DIR\&quot; \&quot;$COMMON_NAME\&quot;&quot; \
</span><span class="z-text z-plain">  | dhall text &gt; &quot;$CA_DIR/ca.conf&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">openssl genpkey \
</span><span class="z-text z-plain">  -algorithm RSA -aes-256-cbc \
</span><span class="z-text z-plain">  -pkeyopt rsa_keygen_bits:4096 \
</span><span class="z-text z-plain">  -out &quot;$CA_DIR/private/ca.key.pem&quot;
</span><span class="z-text z-plain">chmod 400 &quot;$CA_DIR/private/ca.key.pem&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">openssl req \
</span><span class="z-text z-plain">  -new \
</span><span class="z-text z-plain">  -config &quot;$CA_DIR/ca.conf&quot; \
</span><span class="z-text z-plain">  -key &quot;$CA_DIR/private/ca.key.pem&quot; \
</span><span class="z-text z-plain">  -x509 -days 365 \
</span><span class="z-text z-plain">  -out &quot;$CA_DIR/certs/ca.cert.pem&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">openssl x509 \
</span><span class="z-text z-plain">  -outform PEM \
</span><span class="z-text z-plain">  -in &quot;$CA_DIR/certs/ca.cert.pem&quot; \
</span><span class="z-text z-plain">  -out &quot;$CA_DIR/ca.pem&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">echo &quot;Copy &#39;$CA_DIR/ca.pem&#39; to localhost@/etc/nixos/certificates/barracuda/ca.pem&quot;
</span><span class="z-text z-plain">echo &quot;To fit with configuration.nix&quot;
</span><span class="z-text z-plain">echo &quot;pki.certificateFiles = [ ./certificates/barracuda/ca.pem ];&quot;
</span><span class="z-text z-plain">sudo cp &quot;$CA_DIR/certs/ca.cert.pem&quot; /etc/nixos/certificates/barracuda/ca.pem
</span><span class="z-text z-plain">
</span></code></pre>
<p>Note: file names slightly change, beside of that, the main part happen in <code>mk-ca.conf.dhall</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">let openssl =
</span><span class="z-text z-plain">      https://raw.githubusercontent.com/jvanbruegge/dhall-openssl/master/package.dhall
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">let KeyUsage = openssl.KeyUsage
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">in  \(caDir : Text) -&gt;
</span><span class="z-text z-plain">    \(commonName : Text) -&gt;
</span><span class="z-text z-plain">      openssl.mkCaConfig
</span><span class="z-text z-plain">        openssl.CaConfig::{
</span><span class="z-text z-plain">        , distinguishedName = openssl.DistinguishedName::{
</span><span class="z-text z-plain">          , commonName
</span><span class="z-text z-plain">          , country = Some &quot;FR&quot;
</span><span class="z-text z-plain">          , state = Some &quot;France&quot;
</span><span class="z-text z-plain">          , locality = Some &quot;Lyon&quot;
</span><span class="z-text z-plain">          , organization = Some &quot;Black&quot;
</span><span class="z-text z-plain">          , organizationalUnit = Some &quot;A-Team&quot;
</span><span class="z-text z-plain">          }
</span><span class="z-text z-plain">        , allowedHosts = [ &quot;barracuda.local&quot; ]
</span><span class="z-text z-plain">        , caDir
</span><span class="z-text z-plain">        , defaultPolicy = Some &quot;root_ca_policy&quot;
</span><span class="z-text z-plain">        , privateKey = Some &quot;\$base_dir/private/ca.key.pem&quot;
</span><span class="z-text z-plain">        , certificate = Some &quot;\$base_dir/certs/ca.cert.pem&quot;
</span><span class="z-text z-plain">        , usage =
</span><span class="z-text z-plain">          [ KeyUsage.CrlSign, KeyUsage.KeyCertSign, KeyUsage.DigitalSignature ]
</span><span class="z-text z-plain">        }
</span><span class="z-text z-plain">
</span></code></pre>
<p>Let's focus on two points:</p>
<ul>
<li><code>defaultPolicy</code> is now stricter (i.e. it requires all the <code>DistinguishedName</code> attributes to be filled and match them during chain certificates check)</li>
<li><code>usage</code>is increased with <code>DigitalSignature</code></li>
</ul>
<p>Then we have to generate and sign <em>Intermediate CA</em>:</p>
<pre class="z-code"><code><span class="z-text z-plain">##!/usr/bin/env bash
</span><span class="z-text z-plain">set -xeuo pipefail
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">CA_ROOT_DIR=server/generated/ca-root
</span><span class="z-text z-plain">CA_PARENT_DIR=server/generated
</span><span class="z-text z-plain">CA_DIRNAME=ca-intermediate
</span><span class="z-text z-plain">CA_DIR=$CA_PARENT_DIR/$CA_DIRNAME
</span><span class="z-text z-plain">REQ_DIR=server/requests
</span><span class="z-text z-plain">COMMON_NAME=&quot;Barracuda Intermediate CA ($(date --utc +&quot;%Y-%m-%dT%H:%M:%SZ&quot;))&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">mkdir -p $CA_DIR
</span><span class="z-text z-plain">touch $CA_DIR/ca.index
</span><span class="z-text z-plain">openssl rand -hex 16 &gt; $CA_DIR/ca.serial
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">mkdir &quot;$CA_DIR/certs&quot; &quot;$CA_DIR/newcerts&quot; &quot;$CA_DIR/private&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">echo &quot;./$REQ_DIR/mk-ca.conf.dhall \&quot;$CA_DIR\&quot; \&quot;$COMMON_NAME\&quot;&quot; \
</span><span class="z-text z-plain">  | dhall text &gt; &quot;$CA_DIR/ca.conf&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">openssl genpkey \
</span><span class="z-text z-plain">  -algorithm RSA -aes-256-cbc \
</span><span class="z-text z-plain">  -pkeyopt rsa_keygen_bits:4096 \
</span><span class="z-text z-plain">  -out &quot;$CA_DIR/private/ca.key.pem&quot;
</span><span class="z-text z-plain">chmod 400 &quot;$CA_DIR/private/ca.key.pem&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">openssl req \
</span><span class="z-text z-plain">  -new \
</span><span class="z-text z-plain">  -key &quot;$CA_DIR/private/ca.key.pem&quot; \
</span><span class="z-text z-plain">  -config &quot;$CA_DIR/ca.conf&quot; \
</span><span class="z-text z-plain">  -out &quot;$CA_DIR/certs/ca.csr.pem&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">echo &quot;./$REQ_DIR/sign-intermediate-ca.conf.dhall \&quot;$CA_ROOT_DIR\&quot; \&quot;$COMMON_NAME\&quot;&quot; \
</span><span class="z-text z-plain">  | dhall text &gt; &quot;$CA_DIR/sign-ca.conf&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">openssl ca \
</span><span class="z-text z-plain">  -batch \
</span><span class="z-text z-plain">  -config &quot;$CA_DIR/sign-ca.conf&quot; \
</span><span class="z-text z-plain">  -notext \
</span><span class="z-text z-plain">  -in &quot;$CA_DIR/certs/ca.csr.pem&quot; \
</span><span class="z-text z-plain">  -out &quot;$CA_DIR/certs/ca.cert.pem&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">openssl x509 \
</span><span class="z-text z-plain">  -outform PEM \
</span><span class="z-text z-plain">  -in &quot;$CA_DIR/certs/ca.cert.pem&quot; \
</span><span class="z-text z-plain">  -out &quot;$CA_DIR/ca.pem&quot;
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">TARGET_DIR=/etc/nixos/certificates/$CA_PARENT_DIR
</span><span class="z-text z-plain">TARGET_LOGIN=black@192.168.0.4
</span><span class="z-text z-plain">BACKUPS_DIR=/etc/nixos/certificates/backups
</span><span class="z-text z-plain">echo &quot;Copy &#39;$CA_DIR&#39; to barracuda@$TARGET_DIR&quot;
</span><span class="z-text z-plain">scp -r $CA_DIR $TARGET_LOGIN:~
</span><span class="z-text z-plain">ssh $TARGET_LOGIN sudo chown -R root:root $CA_DIRNAME
</span><span class="z-text z-plain">ssh $TARGET_LOGIN sudo mkdir -p $TARGET_DIR
</span><span class="z-text z-plain">ssh $TARGET_LOGIN sudo mv &quot;$TARGET_DIR/$CA_DIRNAME&quot; &quot;$BACKUPS_DIR/server_$(date --utc +&quot;%Y-%m-%dT%H:%M:%SZ&quot;)&quot; || true
</span><span class="z-text z-plain">ssh $TARGET_LOGIN sudo mv $CA_DIRNAME $TARGET_DIR
</span><span class="z-text z-plain">ssh $TARGET_LOGIN sudo systemctl restart nginx.service
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">FINAL_CHAIN_FILE=/etc/nixos/certificates/barracuda/ca.pem
</span><span class="z-text z-plain">TMP_CHAIN_FILE=$(mktemp /tmp/certs-chain-file.XXXXXX)
</span><span class="z-text z-plain">cat &quot;$CA_DIR/certs/ca.cert.pem&quot; &quot;$CA_ROOT_DIR/certs/ca.cert.pem&quot; &gt; &quot;$TMP_CHAIN_FILE&quot;
</span><span class="z-text z-plain">sudo cp &quot;$TMP_CHAIN_FILE&quot; &quot;$FINAL_CHAIN_FILE&quot;
</span><span class="z-text z-plain">
</span></code></pre>
<p>Let's break this down:</p>
<ul>
<li>We create a new CA (with a different <code>commonName</code> to avoid the check failing due to an attack suspicion)</li>
<li>We sign it with the <em>Root CA</em></li>
<li>We build a <em>Certificates Chain File</em>, so we can check server certificates against it</li>
</ul>
<p>Note: here is <code>sign-intermediate-ca.conf.dhall</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">let openssl =
</span><span class="z-text z-plain">      https://raw.githubusercontent.com/jvanbruegge/dhall-openssl/master/package.dhall
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">let KeyUsage = openssl.KeyUsage
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">in  \(caDir : Text) -&gt;
</span><span class="z-text z-plain">    \(commonName : Text) -&gt;
</span><span class="z-text z-plain">      openssl.mkCaConfig
</span><span class="z-text z-plain">        openssl.CaConfig::{
</span><span class="z-text z-plain">        , distinguishedName = openssl.DistinguishedName::{ commonName }
</span><span class="z-text z-plain">        , allowedHosts = [ &quot;barracuda.local&quot; ]
</span><span class="z-text z-plain">        , caDir
</span><span class="z-text z-plain">        , defaultPolicy = Some &quot;intermediate_ca_policy&quot;
</span><span class="z-text z-plain">        , defaultDays = 32
</span><span class="z-text z-plain">        , privateKey = Some &quot;\$base_dir/private/ca.key.pem&quot;
</span><span class="z-text z-plain">        , certificate = Some &quot;\$base_dir/certs/ca.cert.pem&quot;
</span><span class="z-text z-plain">        , pathlen = Some 0
</span><span class="z-text z-plain">        , usage =
</span><span class="z-text z-plain">          [ KeyUsage.CrlSign, KeyUsage.KeyCertSign, KeyUsage.DigitalSignature ]
</span><span class="z-text z-plain">        }
</span></code></pre>
<p>And that's it!</p>
<p>Generating server certificates don't change (except that it now take <em>Intermediate CA</em> instead of the <em>Root CA</em>).</p>
<p>Next time we'll see how and why regenerating short-lived server certificates.</p>

        </section>

        
        
        

        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
        

    </article>
</main>


<script defer src="https://blackheaven.github.io/js/mermaid.min.js"></script><span id="copy-success" class="hidden">
        Copied!
    </span>
    <span id="copy-init" class="hidden">
        Copy code to clipboard
    </span>
    <script defer src="https://blackheaven.github.io/js/copyCodeToClipboard.min.js"></script>
    </div>
    <footer>
    <section>
        <nav class="socials nav-navs">
                <ul>
                    
                    
                    
                    <li>
                        <a class="nav-links no-hover-padding social" rel="noopener" target=_blank href="https://blackheaven.github.io/atom.xml">
                        <img loading="lazy" alt="feed" title="feed" src="https://blackheaven.github.io/social_icons/rss.svg">
                        </a>
                    </li><li class="js"><a class="nav-links no-hover-padding social" href="#" data-encoded-email="Z2F1dGllci5kaWZvbCtibG9nQGdtYWlsLmNvbQ=="><img loading="lazy" alt="email" title="email" src="https://blackheaven.github.io/social_icons/email.svg">
                            </a>
                        </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding social" rel="noopener me" target=_blank href="https://www.linkedin.com/in/gautier-di-folco/">
                                    <img loading="lazy" alt="linkedin" title="linkedin" src="https://blackheaven.github.io/social_icons/linkedin.svg">
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding social" rel="noopener me" target=_blank href="https://github.com/blackheaven/">
                                    <img loading="lazy" alt="github" title="github" src="https://blackheaven.github.io/social_icons/github.svg">
                                </a>
                            </li>
                        
                    
                </ul>
            
        </nav>

        
        <nav class="nav-navs">
        </nav>

        <div class="credits">
            <small>
                

                
                Powered by
                <a rel="noopener" target=_blank href="https://www.getzola.org">Zola</a>
                &amp;
                <a rel="noopener" target=_blank href="https://github.com/welpo/tabi">tabi</a>

                </small>
        </div>
    </section>

    <script src="https://blackheaven.github.io/js/decodeMail.min.js" async></script><div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
    <h1 id="modalTitle" class="visually-hidden">Search</h1>
    <div id="modal-content">
        <div id="searchBar">
            <div class="search-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                </svg>
            </div>
            <input id="searchInput" role="combobox" autocomplete="off" spellcheck="false" aria-expanded="false" aria-controls="results-container" placeholder="Search…"/>
            <div id="clear-search" class="close-icon interactive-icon" tabindex="0" role="button" title="Clear search">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                </svg>
            </div>
        </div>
        <div id="results-container">
            <div id="results-info"><span id="zero_results"> No results</span>
                <span id="one_results"> $NUMBER result</span>
                <span id="many_results"> $NUMBER results</span><span id="two_results"> $NUMBER results</span>
                <span id="few_results"> $NUMBER results</span>
            </div>
            <div id="results" role="listbox"></div>
        </div>
    </div>
</div>
</footer>

</body>

</html>
