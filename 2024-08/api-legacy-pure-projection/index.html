<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://blackheaven.github.io">

    
    <title>Gautier DI FOLCO • Haskell Legacy: Pure projection</title>

    
    
        <link rel="icon" type="image/png" href="https://blackheaven.github.io/favicon-16x16.png"/>
    
    

    
    
        
            
            
                
                    <link rel="alternate" type="application/atom+xml" title="Gautier DI FOLCO - Atom Feed" href="https://blackheaven.github.io/atom.xml">
                
            
        
    

    
    
    
        <link rel="stylesheet" href="https://blackheaven.github.io/inter_subset_en.css?h=d8cf4ad058d6c3a4015b">
    

    
        <link rel="stylesheet" href="https://blackheaven.github.io/main.css?h=4709f1203e8bd6b4162f" />
        <link rel="stylesheet" href="https://blackheaven.github.io/skins/blue.css?h=a4dc1e94d3f5759784d2" />

    <meta name="color-scheme" content="dark" />
        <meta name="description" content="A software engineer website" />
        <meta property="og:description" content="A software engineer website" />

    
        <meta name="robots" content="index, nofollow" />
    

    <meta property="og:title" content="Haskell Legacy: Pure projection" />
    <meta property="og:type" content="article" />

    

    <meta property="og:locale" content="en_GB" />

    <meta property="og:url" content="https:&#x2F;&#x2F;blackheaven.github.io&#x2F;2024-08&#x2F;api-legacy-pure-projection&#x2F;" /><meta property="og:site_name" content="Gautier DI FOLCO"><meta http-equiv="Content-Security-Policy"
content="default-src 'self';font-src &#x27;self&#x27; data: 'self';img-src &#x27;self&#x27; https:&#x2F;&#x2F;* data:;media-src &#x27;self&#x27;;style-src &#x27;self&#x27; 'unsafe-inline';frame-src player.vimeo.com https:&#x2F;&#x2F;www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'">
<script defer src="https://blackheaven.github.io/search_index.en.js?h=9ff10f9e8fb83581467d"></script>
        <script defer src="https://blackheaven.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script>

        </head>


<body>
    <header>
    <nav class="navbar">
        <div class="nav-title">
            <a class="home-title" href="https://blackheaven.github.io">Gautier DI FOLCO</a>
        </div>
            <div class="nav-navs">
                <ul>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/foss/">
                                FOSS Contributions
                                </a>
                            </li>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/activities/">
                                Activities
                                </a>
                            </li>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/hiring/">
                                Hire me
                                </a>
                            </li>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/talks/">
                                Talks
                                </a>
                            </li>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/blog/">
                                Posts
                                </a>
                            </li>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/categories/">
                                Categories
                                </a>
                            </li>
                        
                            <li>
                                
                                <a class="nav-links no-hover-padding" href="https://blackheaven.github.io/tags/">
                                Tags
                                </a>
                            </li>
                        <div class="nav-navs" id="menu-icons-group">
                        <li class="js">
                            <div role="button" tabindex="0" id="search-button" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" aria-label="Click or press $SHORTCUT to open search">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                                </svg>
                            </div>
                        </li>

                        
                        

                        </div>
                </ul>
            </div>
        
    </nav>
</header>

    <div class="content">

        
        




<main>
    <article>
        <h1 class="article-title">
            Haskell Legacy: Pure projection
        </h1>

        <ul class="meta">
                <li>27th Aug 2024</li>
                <li title="138 words"><span class='separator' aria-hidden='true'>•</span>1 min read</li><li class="tag"><span class='separator' aria-hidden='true'>•</span>Tags:&nbsp;</li><li class="tag"><a href="https://blackheaven.github.io/tags/haskell/">haskell</a>,&nbsp;</li><li class="tag"><a href="https://blackheaven.github.io/tags/design/">design</a>,&nbsp;</li><li class="tag"><a href="https://blackheaven.github.io/tags/legacy/">legacy</a>,&nbsp;</li><li class="tag"><a href="https://blackheaven.github.io/tags/polysemy/">polysemy</a></li>
        </ul>

        <section class="body"><p><a href="https://blackheaven.github.io/2024-08/api-legacy-cqrs/">Previously</a> we have extracted our views, so
we had an interpreter based on persistent-projections:</p>
<pre data-lang="haskell" class="language-haskell z-code"><code class="language-haskell" data-lang="haskell"><span class="z-source z-haskell"><span class="z-keyword z-other z-haskell">data</span> <span class="z-constant z-other z-haskell">TrainViewEffect</span> (m <span class="z-keyword z-operator z-haskell">::</span> <span class="z-constant z-other z-haskell">Type</span> <span class="z-keyword z-operator z-haskell">-&gt;</span> <span class="z-constant z-other z-haskell">Type</span>) (a <span class="z-keyword z-operator z-haskell">::</span> <span class="z-constant z-other z-haskell">Type</span>) <span class="z-keyword z-other z-haskell">where</span>
</span><span class="z-source z-haskell">  <span class="z-constant z-other z-haskell">TrainFetch</span> <span class="z-keyword z-operator z-haskell">::</span> <span class="z-constant z-other z-haskell">TrainId</span>&#39; <span class="z-keyword z-operator z-haskell">-&gt;</span> <span class="z-constant z-other z-haskell">TrainViewEffect</span> m <span class="z-constant z-other z-haskell">DisplayedTrain</span>
</span><span class="z-source z-haskell">
</span><span class="z-source z-haskell">makeSem &#39;&#39;<span class="z-constant z-other z-haskell">TrainViewEffect</span>
</span><span class="z-source z-haskell">
</span><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell"><span class="z-entity z-name z-function z-haskell">interpretTrainViewEffectPersistent</span> <span class="z-keyword z-other z-double-colon z-haskell">::</span>
</span></span><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell">  <span class="z-variable z-other z-generic-type z-haskell">forall</span> <span class="z-variable z-other z-generic-type z-haskell">m</span> <span class="z-variable z-other z-generic-type z-haskell">r</span>.
</span></span><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell">  (<span class="z-storage z-type z-haskell">Members</span> &#39;[<span class="z-storage z-type z-haskell">Embed</span> (<span class="z-storage z-type z-haskell">ReaderT</span> <span class="z-storage z-type z-haskell">SqlBackend</span> <span class="z-variable z-other z-generic-type z-haskell">m</span>)] <span class="z-variable z-other z-generic-type z-haskell">r</span>, <span class="z-storage z-type z-haskell">MonadIO</span> <span class="z-variable z-other z-generic-type z-haskell">m</span>) <span class="z-keyword z-other z-big-arrow z-haskell">=&gt;</span>
</span></span><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell">  <span class="z-storage z-type z-haskell">InterpreterFor</span> <span class="z-storage z-type z-haskell">TrainViewEffect</span> <span class="z-variable z-other z-generic-type z-haskell">r</span>
</span></span><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell"></span>interpretTrainViewEffectPersistent <span class="z-keyword z-operator z-haskell">=</span>
</span><span class="z-source z-haskell">  interpret <span class="z-keyword z-operator z-haskell">$</span>
</span><span class="z-source z-haskell">    <span class="z-keyword z-operator z-haskell">\</span><span class="z-keyword z-other z-haskell">case</span>
</span><span class="z-source z-haskell">      <span class="z-constant z-other z-haskell">TrainFetch</span> trainId <span class="z-keyword z-operator z-haskell">-&gt;</span> <span class="z-keyword z-control z-haskell">do</span>
</span><span class="z-source z-haskell">        <span class="z-constant z-other z-haskell">Entity</span> _ train <span class="z-keyword z-operator z-haskell">&lt;-</span> embed <span class="z-keyword z-operator z-haskell">$</span> getBy404 <span class="z-keyword z-operator z-haskell">$</span> <span class="z-constant z-other z-haskell">TrainPrimaryKey</span> trainId
</span><span class="z-source z-haskell">        bookings <span class="z-keyword z-operator z-haskell">&lt;-</span> embed <span class="z-keyword z-operator z-haskell">$</span> select <span class="z-keyword z-operator z-haskell">$</span> from <span class="z-keyword z-operator z-haskell">$</span> <span class="z-keyword z-operator z-haskell">\</span>b <span class="z-keyword z-operator z-haskell">-&gt;</span> where_ (b ^<span class="z-keyword z-operator z-haskell">.</span> <span class="z-constant z-other z-haskell">BookingTrainId</span> <span class="z-keyword z-operator z-haskell">==.</span> val (<span class="z-constant z-other z-haskell">TrainKey</span> trainId)) <span class="z-keyword z-operator z-haskell">$&gt;</span> b
</span><span class="z-source z-haskell">        return <span class="z-keyword z-operator z-haskell">$</span>
</span><span class="z-source z-haskell">          <span class="z-constant z-other z-haskell">DisplayedTrain</span>
</span><span class="z-source z-haskell">            { departureDate <span class="z-keyword z-operator z-haskell">=</span> train<span class="z-keyword z-operator z-haskell">.</span>trainDepartureDate<span class="z-punctuation z-separator z-comma z-haskell">,</span>
</span><span class="z-source z-haskell">              departureStation <span class="z-keyword z-operator z-haskell">=</span> train<span class="z-keyword z-operator z-haskell">.</span>trainDepartureStation<span class="z-punctuation z-separator z-comma z-haskell">,</span>
</span><span class="z-source z-haskell">              arrivalStation <span class="z-keyword z-operator z-haskell">=</span> train<span class="z-keyword z-operator z-haskell">.</span>trainArrivalStation<span class="z-punctuation z-separator z-comma z-haskell">,</span>
</span><span class="z-source z-haskell">              travelers <span class="z-keyword z-operator z-haskell">=</span>
</span><span class="z-source z-haskell">                map
</span><span class="z-source z-haskell">                  ( <span class="z-keyword z-operator z-haskell">\</span>entity <span class="z-keyword z-operator z-haskell">-&gt;</span>
</span><span class="z-source z-haskell">                      <span class="z-constant z-other z-haskell">TravelerRef</span>
</span><span class="z-source z-haskell">                        { bookingId <span class="z-keyword z-operator z-haskell">=</span> entity<span class="z-keyword z-operator z-haskell">.</span>entityVal<span class="z-keyword z-operator z-haskell">.</span>bookingBookingId<span class="z-punctuation z-separator z-comma z-haskell">,</span>
</span><span class="z-source z-haskell">                          travelerName <span class="z-keyword z-operator z-haskell">=</span> entity<span class="z-keyword z-operator z-haskell">.</span>entityVal<span class="z-keyword z-operator z-haskell">.</span>bookingTravelerName
</span><span class="z-source z-haskell">                        }
</span><span class="z-source z-haskell">                  )
</span><span class="z-source z-haskell">                  bookings
</span><span class="z-source z-haskell">            }
</span></code></pre>
<p>It's great on legacy systems for a smooth refactoring, however, for new projects
creating projections, queries, schema can be too much (especially if you want to
build a MVP or a proof-of-concept, or simply because you are not sure that it'll
need to be <em>that</em> fast).</p>
<p>Instead, you can simply load events and compute the projections:</p>
<pre data-lang="haskell" class="language-haskell z-code"><code class="language-haskell" data-lang="haskell"><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell"><span class="z-entity z-name z-function z-haskell">interpretTrainViewEffectEvents</span> <span class="z-keyword z-other z-double-colon z-haskell">::</span>
</span></span><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell">  <span class="z-variable z-other z-generic-type z-haskell">forall</span> <span class="z-variable z-other z-generic-type z-haskell">r</span>.
</span></span><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell">  (<span class="z-storage z-type z-haskell">Members</span> &#39;[<span class="z-storage z-type z-haskell">EventStore</span> <span class="z-storage z-type z-haskell">TrainEvent</span>, <span class="z-storage z-type z-haskell">Embed</span> <span class="z-storage z-type z-haskell">IO</span>, <span class="z-storage z-type z-haskell">Error</span> <span class="z-storage z-type z-haskell">InternalApiError</span>] <span class="z-variable z-other z-generic-type z-haskell">r</span>) <span class="z-keyword z-other z-big-arrow z-haskell">=&gt;</span>
</span></span><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell">  <span class="z-storage z-type z-haskell">InterpreterFor</span> <span class="z-storage z-type z-haskell">TrainViewEffect</span> <span class="z-variable z-other z-generic-type z-haskell">r</span>
</span></span><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell"></span>interpretTrainViewEffectEvents <span class="z-keyword z-operator z-haskell">=</span>
</span><span class="z-source z-haskell">  interpret <span class="z-keyword z-operator z-haskell">$</span>
</span><span class="z-source z-haskell">    <span class="z-keyword z-operator z-haskell">\</span><span class="z-keyword z-other z-haskell">case</span>
</span><span class="z-source z-haskell">      <span class="z-constant z-other z-haskell">TrainFetch</span> trainId <span class="z-keyword z-operator z-haskell">-&gt;</span> <span class="z-keyword z-control z-haskell">do</span>
</span><span class="z-source z-haskell">        <span class="z-keyword z-other z-haskell">let</span> trainStreamId <span class="z-keyword z-operator z-haskell">=</span> <span class="z-constant z-other z-haskell">StreamId</span> trainId<span class="z-keyword z-operator z-haskell">.</span>unTrainId&#39;
</span><span class="z-source z-haskell">        events <span class="z-keyword z-operator z-haskell">&lt;-</span> map snd <span class="z-keyword z-operator z-haskell">&lt;$&gt;</span> fetchEvents trainStreamId
</span><span class="z-source z-haskell">        when (null events) <span class="z-keyword z-operator z-haskell">$</span>
</span><span class="z-source z-haskell">          throw <span class="z-constant z-other z-haskell">NotFoundIAE</span>
</span><span class="z-source z-haskell">
</span><span class="z-source z-haskell">        <span class="z-keyword z-other z-haskell">let</span> go state <span class="z-keyword z-operator z-haskell">=</span>
</span><span class="z-source z-haskell">              <span class="z-keyword z-operator z-haskell">\</span><span class="z-keyword z-other z-haskell">case</span>
</span><span class="z-source z-haskell">                event@(<span class="z-constant z-other z-haskell">TrainCreated</span> {}) <span class="z-keyword z-operator z-haskell">-&gt;</span>
</span><span class="z-source z-haskell">                  <span class="z-constant z-other z-haskell">DisplayedTrain</span>
</span><span class="z-source z-haskell">                    { departureDate <span class="z-keyword z-operator z-haskell">=</span> event<span class="z-keyword z-operator z-haskell">.</span>departureDate<span class="z-punctuation z-separator z-comma z-haskell">,</span>
</span><span class="z-source z-haskell">                      departureStation <span class="z-keyword z-operator z-haskell">=</span> event<span class="z-keyword z-operator z-haskell">.</span>departureStation<span class="z-punctuation z-separator z-comma z-haskell">,</span>
</span><span class="z-source z-haskell">                      arrivalStation <span class="z-keyword z-operator z-haskell">=</span> event<span class="z-keyword z-operator z-haskell">.</span>arrivalStation<span class="z-punctuation z-separator z-comma z-haskell">,</span>
</span><span class="z-source z-haskell">                      travelers <span class="z-keyword z-operator z-haskell">=</span> <span class="z-constant z-language z-empty-list z-haskell">[]</span>
</span><span class="z-source z-haskell">                    }
</span><span class="z-source z-haskell">                event@(<span class="z-constant z-other z-haskell">BookingCreated</span> {}) <span class="z-keyword z-operator z-haskell">-&gt;</span>
</span><span class="z-source z-haskell">                  state
</span><span class="z-source z-haskell">                    { travelers <span class="z-keyword z-operator z-haskell">=</span>
</span><span class="z-source z-haskell">                        state<span class="z-keyword z-operator z-haskell">.</span>travelers
</span><span class="z-source z-haskell">                          <span class="z-keyword z-operator z-haskell">&lt;&gt;</span> [ <span class="z-constant z-other z-haskell">TravelerRef</span>
</span><span class="z-source z-haskell">                                 { bookingId <span class="z-keyword z-operator z-haskell">=</span> <span class="z-constant z-other z-haskell">BookingId</span>&#39; <span class="z-keyword z-operator z-haskell">$</span> fromIntegral event<span class="z-keyword z-operator z-haskell">.</span>id<span class="z-punctuation z-separator z-comma z-haskell">,</span>
</span><span class="z-source z-haskell">                                   travelerName <span class="z-keyword z-operator z-haskell">=</span> event<span class="z-keyword z-operator z-haskell">.</span>travelerName
</span><span class="z-source z-haskell">                                 }
</span><span class="z-source z-haskell">                             ]
</span><span class="z-source z-haskell">                    }
</span><span class="z-source z-haskell">                event@(<span class="z-constant z-other z-haskell">BookingWithdrawn</span> {}) <span class="z-keyword z-operator z-haskell">-&gt;</span>
</span><span class="z-source z-haskell">                  <span class="z-keyword z-other z-haskell">let</span> bookingId <span class="z-keyword z-operator z-haskell">=</span> <span class="z-constant z-other z-haskell">BookingId</span>&#39; <span class="z-keyword z-operator z-haskell">$</span> fromIntegral event<span class="z-keyword z-operator z-haskell">.</span>id
</span><span class="z-source z-haskell">                   <span class="z-keyword z-other z-haskell">in</span> state
</span><span class="z-source z-haskell">                        { travelers <span class="z-keyword z-operator z-haskell">=</span> filter ((<span class="z-keyword z-operator z-haskell">/=</span> bookingId) <span class="z-keyword z-operator z-haskell">.</span> (<span class="z-keyword z-operator z-haskell">.</span>bookingId)) state<span class="z-keyword z-operator z-haskell">.</span>travelers
</span><span class="z-source z-haskell">                        }
</span><span class="z-source z-haskell">        return <span class="z-keyword z-operator z-haskell">$</span> foldl go (error <span class="z-string z-quoted z-double z-haskell"><span class="z-punctuation z-definition z-string z-begin z-haskell">&quot;</span>Invalid stream<span class="z-punctuation z-definition z-string z-end z-haskell">&quot;</span></span>) events
</span></code></pre>
<p>Note: we I introduce it, it can be controversial, it's true that this of kind
implementations can be potentially expensive, but it's perfectly valid for not
frequently used views, or features we aim to explore.</p>
<p>Note 2: if this view become critical, a simple key-value store can be used as
cache, even being built incrementally, event-by-event.</p>

        </section>

        
        
        

        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
        

    </article>
</main>


<script defer src="https://blackheaven.github.io/js/mermaid.min.js"></script><span id="copy-success" class="hidden">
        Copied!
    </span>
    <span id="copy-init" class="hidden">
        Copy code to clipboard
    </span>
    <script defer src="https://blackheaven.github.io/js/copyCodeToClipboard.min.js"></script>
    </div>
    <footer>
    <section>
        <nav class="socials nav-navs">
                <ul>
                    
                    
                    
                    <li>
                        <a class="nav-links no-hover-padding social" rel="noopener" target=_blank href="https://blackheaven.github.io/atom.xml">
                        <img loading="lazy" alt="feed" title="feed" src="https://blackheaven.github.io/social_icons/rss.svg">
                        </a>
                    </li><li class="js"><a class="nav-links no-hover-padding social" href="#" data-encoded-email="Z2F1dGllci5kaWZvbCtibG9nQGdtYWlsLmNvbQ=="><img loading="lazy" alt="email" title="email" src="https://blackheaven.github.io/social_icons/email.svg">
                            </a>
                        </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding social" rel="noopener me" target=_blank href="https://www.linkedin.com/in/gautier-di-folco/">
                                    <img loading="lazy" alt="linkedin" title="linkedin" src="https://blackheaven.github.io/social_icons/linkedin.svg">
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding social" rel="noopener me" target=_blank href="https://github.com/blackheaven/">
                                    <img loading="lazy" alt="github" title="github" src="https://blackheaven.github.io/social_icons/github.svg">
                                </a>
                            </li>
                        
                    
                </ul>
            
        </nav>

        
        <nav class="nav-navs">
        </nav>

        <div class="credits">
            <small>
                

                
                Powered by
                <a rel="noopener" target=_blank href="https://www.getzola.org">Zola</a>
                &amp;
                <a rel="noopener" target=_blank href="https://github.com/welpo/tabi">tabi</a>

                </small>
        </div>
    </section>

    <script src="https://blackheaven.github.io/js/decodeMail.min.js" async></script><div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
    <h1 id="modalTitle" class="visually-hidden">Search</h1>
    <div id="modal-content">
        <div id="searchBar">
            <div class="search-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                </svg>
            </div>
            <input id="searchInput" role="combobox" autocomplete="off" spellcheck="false" aria-expanded="false" aria-controls="results-container" placeholder="Search…"/>
            <div id="clear-search" class="close-icon interactive-icon" tabindex="0" role="button" title="Clear search">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                </svg>
            </div>
        </div>
        <div id="results-container">
            <div id="results-info"><span id="zero_results"> No results</span>
                <span id="one_results"> $NUMBER result</span>
                <span id="many_results"> $NUMBER results</span><span id="two_results"> $NUMBER results</span>
                <span id="few_results"> $NUMBER results</span>
            </div>
            <div id="results" role="listbox"></div>
        </div>
    </div>
</div>
</footer>

</body>

</html>
